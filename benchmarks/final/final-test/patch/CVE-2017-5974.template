 159 | /** convert a zip disk entry to internal format.
 160 |  * creates a new item parsing the information out of the various places
 161 |  * in the zip archive. This is a good place to extend functionality if
 162 |  * you have a project with extra requirements as you can push more bits
 163 |  * right into the diskdir_entry for later usage in higher layers.
 164 |  * returns: new item, or null on error (setting errno)
 165 |  */
 166 | zzip__new__ ZZIP_MEM_ENTRY *
 167 | zzip_mem_entry_new(ZZIP_DISK * disk, ZZIP_DISK_ENTRY * entry)
 168 | {
 169 |     if (! disk || ! entry)
 170 |         { errno=EINVAL; return 0; }
 171 |     ___ ZZIP_MEM_ENTRY *item = calloc(1, sizeof(*item));
 172 |     if (! item)
 173 |         return 0;               /* errno=ENOMEM; */
 174 |     ___ struct zzip_file_header *header =
 175 |         zzip_disk_entry_to_file_header(disk, entry);
 176 |     /*  there is a number of duplicated information in the file header
 177 |      *  or the disk entry block. Theoretically some part may be missing
 178 |      *  that exists in the other, ... but we will prefer the disk entry.
 179 |      */
 180 |     item->zz_comment = zzip_disk_entry_strdup_comment(disk, entry);
 181 |     item->zz_name = zzip_disk_entry_strdup_name(disk, entry);
 182 |     item->zz_data = zzip_file_header_to_data(header);
 183 |     item->zz_flags = zzip_disk_entry_get_flags(entry);
 184 |     item->zz_compr = zzip_disk_entry_get_compr(entry);
 185 |     item->zz_mktime = zzip_disk_entry_get_mktime(entry);
 186 |     item->zz_crc32 = zzip_disk_entry_get_crc32(entry);
 187 |     item->zz_csize = zzip_disk_entry_get_csize(entry);
 188 |     item->zz_usize = zzip_disk_entry_get_usize(entry);
 189 |     item->zz_diskstart = zzip_disk_entry_get_diskstart(entry);
 190 |     item->zz_filetype = zzip_disk_entry_get_filetype(entry);
 191 | 
 192 |     {                           /* copy the extra blocks to memory as well */
 193 |         int /*            */ ext1 = zzip_disk_entry_get_extras(entry);
 194 |         char *_zzip_restrict ptr1 = zzip_disk_entry_to_extras(entry);
 195 |         int /*            */ ext2 = zzip_file_header_get_extras(header);
 196 |         char *_zzip_restrict ptr2 = zzip_file_header_to_extras(header); // PATCH LOCATION 197 | 
 198 |         if (ext1)
 199 |         {
 200 |             void *mem = malloc(ext1 + 2);
 201 |             item->zz_ext[1] = mem;
 202 |             memcpy(mem, ptr1, ext1);
 203 |             ((char *) (mem))[ext1 + 0] = 0;
 204 |             ((char *) (mem))[ext1 + 1] = 0;
 205 |         }
 206 |         if (ext2)
 207 |         {
 208 |             void *mem = malloc(ext2 + 2);
 209 |             item->zz_ext[2] = mem;
 210 |             memcpy(mem, ptr2, ext2);
 211 |             ((char *) (mem))[ext2 + 0] = 0;
 212 |             ((char *) (mem))[ext2 + 1] = 0;
 213 |         }
 214 |     }
 215 |     {
 216 |         /* override sizes/offsets with zip64 values for largefile support */
 217 |         zzip_extra_zip64 *block = (zzip_extra_zip64 *)
 218 |             zzip_mem_entry_extra_block(item, ZZIP_EXTRA_zip64);
 219 |         if (block)
 220 |         {
 221 |             item->zz_usize = ZZIP_GET64(block->z_usize);
 222 |             item->zz_csize = ZZIP_GET64(block->z_csize);
 223 |             item->zz_offset = ZZIP_GET64(block->z_offset);
 224 |             item->zz_diskstart = ZZIP_GET32(block->z_diskstart);
 225 |         }
 226 |     }
 227 |     /* NOTE:
 228 |      * All information from the central directory entry is now in memory.
 229 |      * Effectivly that allows us to modify it and write it back to disk.
 230 |      */
 231 |     return item;
 232 |     ____;
 233 |     ____;
 234 | }
 235 | 
