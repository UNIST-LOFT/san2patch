  65 | void printMP3Headers(FILE *f)
  66 | {
  67 |   unsigned long flags;
  68 |   int frameLen, numFrames = 0;
  69 |   int bitrate=0, bitrate_idx, samplerate=0, samplerate_idx;
  70 |   int version, layer, channels, padding;
  71 |   int bitrateSum = 0;
  72 |   int length;
  73 | 
  74 |   for(;;)
  75 |   {
  76 |     /* get 4-byte header, bigendian */
  77 |     if((flags = fgetc(f)) == EOF)
  78 |       break;
  79 | 
  80 |     /* XXX - fix this mad hackery */
  81 |     if(flags == 'I' && fgetc(f) == 'D' && fgetc(f) == '3')
  82 |     {
  83 |       do
  84 |       {
  85 | 	flags = fgetc(f);
  86 |       }
  87 |       while(flags != 0xFF && flags != EOF);
  88 |     }
  89 | 
  90 |     if(flags == EOF)
  91 |       break;
  92 | 
  93 |     flags <<= 24;
  94 |     flags += fgetc(f) << 16;
  95 |     flags += fgetc(f) << 8;
  96 |     flags += fgetc(f);
  97 | 
  98 |     if((flags & MP3_FRAME_SYNC) != MP3_FRAME_SYNC)
  99 |       break;
 100 |     /*      error("bad sync on MP3 block!"); */
 101 | 
 102 |     ++numFrames;
 103 | 
 104 |     bitrate_idx = (flags & MP3_BITRATE) >> MP3_BITRATE_SHIFT; // PATCH LOCATION 105 |     samplerate_idx = (flags & MP3_SAMPLERATE) >> MP3_SAMPLERATE_SHIFT;
 106 | 
 107 |     channels = ((flags & MP3_CHANNEL) == MP3_CHANNEL_MONO) ? 1 : 2;
 108 | 
 109 |     switch(flags & MP3_VERSION)
 110 |     {
 111 |       case MP3_VERSION_1:  version = 1; break;
 112 |       case MP3_VERSION_2:  version = 2; break;
 113 |       case MP3_VERSION_25: version = 25; break;
 114 |       default: error("unknown MP3 version!");
 115 |     }
 116 |     switch(flags & MP3_LAYER)
 117 |     {
 118 |       case MP3_LAYER_1: layer = 1; break;
 119 |       case MP3_LAYER_2: layer = 2; break;
 120 |       case MP3_LAYER_3: layer = 3; break;
 121 |       default: error("unknown MP3 layer!");
 122 |     }
 123 | 
 124 |     bitrateSum += bitrate;
 125 | 
 126 |     if(version == 1)
 127 |     {
 128 |       samplerate = mp1_samplerate_table[samplerate_idx];
 129 | 
 130 |       if(layer == 1)
 131 | 	bitrate = mp1l1_bitrate_table[bitrate_idx];
 132 | 
 133 |       else if(layer == 2)
 134 | 	bitrate = mp1l2_bitrate_table[bitrate_idx];
 135 | 
 136 |       else if(layer == 3)
 137 | 	bitrate = mp1l3_bitrate_table[bitrate_idx];
 138 |     }
 139 |     else
 140 |     {
 141 |       if(version == 2)
 142 | 	samplerate = mp2_samplerate_table[samplerate_idx];
 143 |       else
 144 | 	samplerate = mp25_samplerate_table[samplerate_idx];
 145 | 
 146 |       if(layer == 1)
 147 | 	bitrate = mp2l1_bitrate_table[bitrate_idx];
 148 |       else
 149 | 	bitrate = mp2l23_bitrate_table[bitrate_idx];
 150 |     }
 151 | 
 152 |     padding = (flags & MP3_PADDING) ? 1 : 0;
 153 | 
 154 |     if(layer == 1)
 155 |       padding <<= 2;
 156 | 
 157 |     if(version == 1)
 158 |       frameLen = 144 * bitrate * 1000 / samplerate + padding;
 159 |     else
 160 |       frameLen = 72 * bitrate * 1000 / samplerate + padding;
 161 | 
 162 |     printf("frame %i: MP%i layer %i, %i Hz, %ikbps, %s, length=%i, protect %s\n",
 163 | 	   numFrames, version, layer, samplerate, bitrate,
 164 | 	   (channels==2) ? "stereo" : "mono", frameLen,
 165 | 	   (flags&MP3_PROTECT) ? "on" : "off");
 166 | 
 167 |     skipBytes(f, frameLen-4);
 168 |   }
 169 | 
 170 |   putchar('\n');
 171 | 
 172 |   length = numFrames*(samplerate > 3200 ? 1152 : 576)/samplerate;
 173 | 
 174 |   printf("Number of frames: %i\n", numFrames);
 175 |   printf("Average bitrate: %i\n", bitrateSum/numFrames);
 176 |   printf("Length: %i:%02i\n", length/60, length%60);
 177 | }
