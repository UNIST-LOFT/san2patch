2761 | tsize_t t2p_readwrite_pdf_image_tile(T2P* t2p, TIFF* input, TIFF* output, ttile_t tile){
2762 | 
2763 | 	uint16 edge=0;
2764 | 	tsize_t written=0;
2765 | 	unsigned char* buffer=NULL;
2766 | 	tsize_t bufferoffset=0;
2767 | 	unsigned char* samplebuffer=NULL;
2768 | 	tsize_t samplebufferoffset=0;
2769 | 	tsize_t read=0;
2770 | 	uint16 i=0;
2771 | 	ttile_t tilecount=0;
2772 | 	/* tsize_t tilesize=0; */
2773 | 	ttile_t septilecount=0;
2774 | 	tsize_t septilesize=0;
2775 | #ifdef JPEG_SUPPORT
2776 | 	unsigned char* jpt;
2777 | 	float* xfloatp;
2778 | 	uint32 xuint32=0;
2779 | #endif
2780 | 
2781 | 	/* Fail if prior error (in particular, can't trust tiff_datasize) */
2782 | 	if (t2p->t2p_error != T2P_ERR_OK)
2783 | 		return(0);
2784 | 
2785 | 	edge |= t2p_tile_is_right_edge(t2p->tiff_tiles[t2p->pdf_page], tile);
2786 | 	edge |= t2p_tile_is_bottom_edge(t2p->tiff_tiles[t2p->pdf_page], tile);
2787 | 
2788 | 	if( (t2p->pdf_transcode == T2P_TRANSCODE_RAW) && ((edge == 0)
2789 | #if defined(JPEG_SUPPORT) || defined(OJPEG_SUPPORT)
2790 | 		|| (t2p->pdf_compression == T2P_COMPRESS_JPEG)
2791 | #endif
2792 | 	)
2793 | 	){
2794 | #ifdef CCITT_SUPPORT
2795 | 		if(t2p->pdf_compression == T2P_COMPRESS_G4){
2796 | 			buffer= (unsigned char*) _TIFFmalloc(t2p->tiff_datasize);
2797 | 			if(buffer==NULL){
2798 | 				TIFFError(TIFF2PDF_MODULE, 
2799 | 					"Can't allocate %lu bytes of memory "
2800 |                                         "for t2p_readwrite_pdf_image_tile, %s", 
2801 | 					(unsigned long) t2p->tiff_datasize, 
2802 | 					TIFFFileName(input));
2803 | 				t2p->t2p_error = T2P_ERR_ERROR;
2804 | 				return(0);
2805 | 			}
2806 | 			TIFFReadRawTile(input, tile, (tdata_t) buffer, t2p->tiff_datasize);
2807 | 			if (t2p->tiff_fillorder==FILLORDER_LSB2MSB){
2808 | 					TIFFReverseBits(buffer, t2p->tiff_datasize);
2809 | 			}
2810 | 			t2pWriteFile(output, (tdata_t) buffer, t2p->tiff_datasize);
2811 | 			_TIFFfree(buffer);
2812 | 			return(t2p->tiff_datasize);
2813 | 		}
2814 | #endif
2815 | #ifdef ZIP_SUPPORT
2816 | 		if(t2p->pdf_compression == T2P_COMPRESS_ZIP){
2817 | 			buffer= (unsigned char*) _TIFFmalloc(t2p->tiff_datasize);
2818 | 			if(buffer==NULL){
2819 | 				TIFFError(TIFF2PDF_MODULE, 
2820 | 					"Can't allocate %lu bytes of memory "
2821 |                                         "for t2p_readwrite_pdf_image_tile, %s", 
2822 | 					(unsigned long) t2p->tiff_datasize, 
2823 | 					TIFFFileName(input));
2824 | 				t2p->t2p_error = T2P_ERR_ERROR;
2825 | 				return(0);
2826 | 			}
2827 | 			TIFFReadRawTile(input, tile, (tdata_t) buffer, t2p->tiff_datasize);
2828 | 			if (t2p->tiff_fillorder==FILLORDER_LSB2MSB){
2829 | 					TIFFReverseBits(buffer, t2p->tiff_datasize);
2830 | 			}
2831 | 			t2pWriteFile(output, (tdata_t) buffer, t2p->tiff_datasize);
2832 | 			_TIFFfree(buffer);
2833 | 			return(t2p->tiff_datasize);
2834 | 		}
2835 | #endif
2836 | #ifdef OJPEG_SUPPORT
2837 | 		if(t2p->tiff_compression == COMPRESSION_OJPEG){
2838 | 			if(! t2p->pdf_ojpegdata){
2839 | 				TIFFError(TIFF2PDF_MODULE, 
2840 | 					"No support for OJPEG image %s with "
2841 |                                         "bad tables", 
2842 | 					TIFFFileName(input));
2843 | 				t2p->t2p_error = T2P_ERR_ERROR;
2844 | 				return(0);
2845 | 			}
2846 | 			buffer=(unsigned char*) _TIFFmalloc(t2p->tiff_datasize);
2847 | 			if(buffer==NULL){
2848 | 				TIFFError(TIFF2PDF_MODULE, 
2849 | 					"Can't allocate %lu bytes of memory "
2850 |                                         "for t2p_readwrite_pdf_image, %s", 
2851 | 					(unsigned long) t2p->tiff_datasize, 
2852 | 					TIFFFileName(input));
2853 | 				t2p->t2p_error = T2P_ERR_ERROR;
2854 | 				return(0);
2855 | 			}
2856 | 			_TIFFmemcpy(buffer, t2p->pdf_ojpegdata, t2p->pdf_ojpegdatalength);
2857 | 			if(edge!=0){
2858 | 				if(t2p_tile_is_bottom_edge(t2p->tiff_tiles[t2p->pdf_page], tile)){
2859 | 					buffer[7]=
2860 | 						(t2p->tiff_tiles[t2p->pdf_page].tiles_edgetilelength >> 8) & 0xff;
2861 | 					buffer[8]=
2862 | 						(t2p->tiff_tiles[t2p->pdf_page].tiles_edgetilelength ) & 0xff;
2863 | 				}
2864 | 				if(t2p_tile_is_right_edge(t2p->tiff_tiles[t2p->pdf_page], tile)){
2865 | 					buffer[9]=
2866 | 						(t2p->tiff_tiles[t2p->pdf_page].tiles_edgetilewidth >> 8) & 0xff;
2867 | 					buffer[10]=
2868 | 						(t2p->tiff_tiles[t2p->pdf_page].tiles_edgetilewidth ) & 0xff;
2869 | 				}
2870 | 			}
2871 | 			bufferoffset=t2p->pdf_ojpegdatalength;
2872 | 			bufferoffset+=TIFFReadRawTile(input, 
2873 | 					tile, 
2874 | 					(tdata_t) &(((unsigned char*)buffer)[bufferoffset]), 
2875 | 					-1);
2876 | 			((unsigned char*)buffer)[bufferoffset++]=0xff;
2877 | 			((unsigned char*)buffer)[bufferoffset++]=0xd9;
2878 | 			t2pWriteFile(output, (tdata_t) buffer, bufferoffset);
2879 | 			_TIFFfree(buffer);
2880 | 			return(bufferoffset);
2881 | 		}
2882 | #endif
2883 | #ifdef JPEG_SUPPORT
2884 | 		if(t2p->tiff_compression == COMPRESSION_JPEG){
2885 | 			unsigned char table_end[2];
2886 | 			uint32 count = 0;
2887 | 			buffer= (unsigned char*) _TIFFmalloc(t2p->tiff_datasize);
2888 | 			if(buffer==NULL){
2889 | 				TIFFError(TIFF2PDF_MODULE, 
2890 | 					"Can't allocate " TIFF_SIZE_FORMAT " bytes of memory "
2891 |                                         "for t2p_readwrite_pdf_image_tile, %s", 
2892 |                                           (TIFF_SIZE_T) t2p->tiff_datasize, 
2893 | 					TIFFFileName(input));
2894 | 				t2p->t2p_error = T2P_ERR_ERROR;
2895 | 				return(0);
2896 | 			}
2897 | 			if(TIFFGetField(input, TIFFTAG_JPEGTABLES, &count, &jpt) != 0) { // PATCH LOCATION
2898 | 				if (count >= 4) {
2899 |                                         int retTIFFReadRawTile;
2900 |                     /* Ignore EOI marker of JpegTables */
2901 | 					_TIFFmemcpy(buffer, jpt, count - 2);
2902 | 					bufferoffset += count - 2;
2903 |                     /* Store last 2 bytes of the JpegTables */
2904 | 					table_end[0] = buffer[bufferoffset-2];
2905 | 					table_end[1] = buffer[bufferoffset-1];
2906 | 					xuint32 = bufferoffset;
2907 |                                         bufferoffset -= 2;
2908 |                                         retTIFFReadRawTile= TIFFReadRawTile(
2909 | 						input, 
2910 | 						tile, 
2911 | 						(tdata_t) &(((unsigned char*)buffer)[bufferoffset]), 
2912 | 						-1);
2913 |                                         if( retTIFFReadRawTile < 0 )
2914 |                                         {
2915 |                                             _TIFFfree(buffer);
2916 |                                             t2p->t2p_error = T2P_ERR_ERROR;
2917 |                                             return(0);
2918 |                                         }
2919 | 					bufferoffset += retTIFFReadRawTile;
2920 |                     /* Overwrite SOI marker of image scan with previously */
2921 |                     /* saved end of JpegTables */
2922 | 					buffer[xuint32-2]=table_end[0];
2923 | 					buffer[xuint32-1]=table_end[1];
2924 | 				}
2925 | 			}
2926 | 			t2pWriteFile(output, (tdata_t) buffer, bufferoffset);
2927 | 			_TIFFfree(buffer);
2928 | 			return(bufferoffset);
2929 | 		}
2930 | #endif
2931 | 		(void)0;
2932 | 	}
2933 | 
2934 | 	if(t2p->pdf_sample==T2P_SAMPLE_NOTHING){
2935 | 		buffer = (unsigned char*) _TIFFmalloc(t2p->tiff_datasize);
2936 | 		if(buffer==NULL){
2937 | 			TIFFError(TIFF2PDF_MODULE, 
2938 | 				"Can't allocate %lu bytes of memory for "
2939 |                                 "t2p_readwrite_pdf_image_tile, %s", 
2940 | 				(unsigned long) t2p->tiff_datasize, 
2941 | 				TIFFFileName(input));
2942 | 			t2p->t2p_error = T2P_ERR_ERROR;
2943 | 			return(0);
2944 | 		}
2945 | 
2946 | 		read = TIFFReadEncodedTile(
2947 | 			input, 
2948 | 			tile, 
2949 | 			(tdata_t) &buffer[bufferoffset], 
2950 | 			t2p->tiff_datasize);
2951 | 		if(read==-1){
2952 | 			TIFFError(TIFF2PDF_MODULE, 
2953 | 				"Error on decoding tile %u of %s", 
2954 | 				tile, 
2955 | 				TIFFFileName(input));
2956 | 			_TIFFfree(buffer);
2957 | 			t2p->t2p_error=T2P_ERR_ERROR;
2958 | 			return(0);
2959 | 		}
2960 | 
2961 | 	} else {
2962 | 
2963 | 		if(t2p->pdf_sample == T2P_SAMPLE_PLANAR_SEPARATE_TO_CONTIG){
2964 | 			septilesize=TIFFTileSize(input);
2965 | 			septilecount=TIFFNumberOfTiles(input);
2966 | 			/* tilesize=septilesize*t2p->tiff_samplesperpixel; */
2967 | 			tilecount=septilecount/t2p->tiff_samplesperpixel;
2968 | 			buffer = (unsigned char*) _TIFFmalloc(t2p->tiff_datasize);
2969 | 			if(buffer==NULL){
2970 | 				TIFFError(TIFF2PDF_MODULE, 
2971 | 					"Can't allocate %lu bytes of memory "
2972 |                                         "for t2p_readwrite_pdf_image_tile, %s", 
2973 | 					(unsigned long) t2p->tiff_datasize, 
2974 | 					TIFFFileName(input));
2975 | 				t2p->t2p_error = T2P_ERR_ERROR;
2976 | 				return(0);
2977 | 			}
2978 | 			samplebuffer = (unsigned char*) _TIFFmalloc(t2p->tiff_datasize);
2979 | 			if(samplebuffer==NULL){
2980 | 				TIFFError(TIFF2PDF_MODULE, 
2981 | 					"Can't allocate %lu bytes of memory "
2982 |                                         "for t2p_readwrite_pdf_image_tile, %s", 
2983 | 					(unsigned long) t2p->tiff_datasize, 
2984 | 					TIFFFileName(input));
2985 | 				t2p->t2p_error = T2P_ERR_ERROR;
2986 | 				return(0);
2987 | 			}
2988 | 			samplebufferoffset=0;
2989 | 			for(i=0;i<t2p->tiff_samplesperpixel;i++){
2990 | 				read = 
2991 | 					TIFFReadEncodedTile(input, 
2992 | 						tile + i*tilecount, 
2993 | 						(tdata_t) &(samplebuffer[samplebufferoffset]), 
2994 | 						septilesize);
2995 | 				if(read==-1){
2996 | 					TIFFError(TIFF2PDF_MODULE, 
2997 | 						"Error on decoding tile %u of %s", 
2998 | 						tile + i*tilecount, 
2999 | 						TIFFFileName(input));
3000 | 						_TIFFfree(samplebuffer);
3001 | 						_TIFFfree(buffer);
3002 | 					t2p->t2p_error=T2P_ERR_ERROR;
3003 | 					return(0);
3004 | 				}
3005 | 				samplebufferoffset+=read;
3006 | 			}
3007 | 			t2p_sample_planar_separate_to_contig(
3008 | 				t2p,
3009 | 				&(buffer[bufferoffset]),
3010 | 				samplebuffer, 
3011 | 				samplebufferoffset); 
3012 | 			bufferoffset+=samplebufferoffset;
3013 | 			_TIFFfree(samplebuffer);
3014 | 		}
3015 | 
3016 | 		if(buffer==NULL){
3017 | 			buffer = (unsigned char*) _TIFFmalloc(t2p->tiff_datasize);
3018 | 			if(buffer==NULL){
3019 | 				TIFFError(TIFF2PDF_MODULE, 
3020 | 					"Can't allocate %lu bytes of memory "
3021 |                                         "for t2p_readwrite_pdf_image_tile, %s", 
3022 | 					(unsigned long) t2p->tiff_datasize, 
3023 | 					TIFFFileName(input));
3024 | 				t2p->t2p_error = T2P_ERR_ERROR;
3025 | 				return(0);
3026 | 			}
3027 | 			read = TIFFReadEncodedTile(
3028 | 				input, 
3029 | 				tile, 
3030 | 				(tdata_t) &buffer[bufferoffset], 
3031 | 				t2p->tiff_datasize);
3032 | 			if(read==-1){
3033 | 				TIFFError(TIFF2PDF_MODULE, 
3034 | 					"Error on decoding tile %u of %s", 
3035 | 					tile, 
3036 | 					TIFFFileName(input));
3037 | 				_TIFFfree(buffer);
3038 | 				t2p->t2p_error=T2P_ERR_ERROR;
3039 | 				return(0);
3040 | 			}
3041 | 		}
3042 | 
3043 | 		if(t2p->pdf_sample & T2P_SAMPLE_RGBA_TO_RGB){
3044 | 			t2p->tiff_datasize=t2p_sample_rgba_to_rgb(
3045 | 				(tdata_t)buffer, 
3046 | 				t2p->tiff_tiles[t2p->pdf_page].tiles_tilewidth
3047 | 				*t2p->tiff_tiles[t2p->pdf_page].tiles_tilelength);
3048 | 		}
3049 | 
3050 | 		if(t2p->pdf_sample & T2P_SAMPLE_RGBAA_TO_RGB){
3051 | 			t2p->tiff_datasize=t2p_sample_rgbaa_to_rgb(
3052 | 				(tdata_t)buffer, 
3053 | 				t2p->tiff_tiles[t2p->pdf_page].tiles_tilewidth
3054 | 				*t2p->tiff_tiles[t2p->pdf_page].tiles_tilelength);
3055 | 		}
3056 | 
3057 | 		if(t2p->pdf_sample & T2P_SAMPLE_YCBCR_TO_RGB){
3058 | 			TIFFError(TIFF2PDF_MODULE, 
3059 | 				"No support for YCbCr to RGB in tile for %s", 
3060 | 				TIFFFileName(input));
3061 | 			_TIFFfree(buffer);
3062 | 			t2p->t2p_error = T2P_ERR_ERROR;
3063 | 			return(0);
3064 | 		}
3065 | 
3066 | 		if(t2p->pdf_sample & T2P_SAMPLE_LAB_SIGNED_TO_UNSIGNED){
3067 | 			t2p->tiff_datasize=t2p_sample_lab_signed_to_unsigned(
3068 | 				(tdata_t)buffer, 
3069 | 				t2p->tiff_tiles[t2p->pdf_page].tiles_tilewidth
3070 | 				*t2p->tiff_tiles[t2p->pdf_page].tiles_tilelength);
3071 | 		}
3072 | 	}
3073 | 
3074 | 	if(t2p_tile_is_right_edge(t2p->tiff_tiles[t2p->pdf_page], tile) != 0){
3075 | 		t2p_tile_collapse_left(
3076 | 			buffer, 
3077 | 			TIFFTileRowSize(input),
3078 | 			t2p->tiff_tiles[t2p->pdf_page].tiles_tilewidth,
3079 | 			t2p->tiff_tiles[t2p->pdf_page].tiles_edgetilewidth, 
3080 | 			t2p->tiff_tiles[t2p->pdf_page].tiles_tilelength);
3081 | 	}
3082 | 
3083 | 
3084 | 	t2p_disable(output);
3085 | 	TIFFSetField(output, TIFFTAG_PHOTOMETRIC, t2p->tiff_photometric);
3086 | 	TIFFSetField(output, TIFFTAG_BITSPERSAMPLE, t2p->tiff_bitspersample);
3087 | 	TIFFSetField(output, TIFFTAG_SAMPLESPERPIXEL, t2p->tiff_samplesperpixel);
3088 | 	if(t2p_tile_is_right_edge(t2p->tiff_tiles[t2p->pdf_page], tile) == 0){
3089 | 		TIFFSetField(
3090 | 			output, 
3091 | 			TIFFTAG_IMAGEWIDTH, 
3092 | 			t2p->tiff_tiles[t2p->pdf_page].tiles_tilewidth);
3093 | 	} else {
3094 | 		TIFFSetField(
3095 | 			output, 
3096 | 			TIFFTAG_IMAGEWIDTH, 
3097 | 			t2p->tiff_tiles[t2p->pdf_page].tiles_edgetilewidth);
3098 | 	}
3099 | 	if(t2p_tile_is_bottom_edge(t2p->tiff_tiles[t2p->pdf_page], tile) == 0){
3100 | 		TIFFSetField(
3101 | 			output, 
3102 | 			TIFFTAG_IMAGELENGTH, 
3103 | 			t2p->tiff_tiles[t2p->pdf_page].tiles_tilelength);
3104 | 		TIFFSetField(
3105 | 			output, 
3106 | 			TIFFTAG_ROWSPERSTRIP, 
3107 | 			t2p->tiff_tiles[t2p->pdf_page].tiles_tilelength);
3108 | 	} else {
3109 | 		TIFFSetField(
3110 | 			output, 
3111 | 			TIFFTAG_IMAGELENGTH, 
3112 | 			t2p->tiff_tiles[t2p->pdf_page].tiles_edgetilelength);
3113 | 		TIFFSetField(
3114 | 			output, 
3115 | 			TIFFTAG_ROWSPERSTRIP, 
3116 | 			t2p->tiff_tiles[t2p->pdf_page].tiles_edgetilelength);
3117 | 	}
3118 | 	TIFFSetField(output, TIFFTAG_PLANARCONFIG, PLANARCONFIG_CONTIG);
3119 | 	TIFFSetField(output, TIFFTAG_FILLORDER, FILLORDER_MSB2LSB);
3120 | 
3121 | 	switch(t2p->pdf_compression){
3122 | 	case T2P_COMPRESS_NONE:
3123 | 		TIFFSetField(output, TIFFTAG_COMPRESSION, COMPRESSION_NONE);
3124 | 		break;
3125 | #ifdef CCITT_SUPPORT
3126 | 	case T2P_COMPRESS_G4:
3127 | 		TIFFSetField(output, TIFFTAG_COMPRESSION, COMPRESSION_CCITTFAX4);
3128 | 		break;
3129 | #endif
3130 | #ifdef JPEG_SUPPORT
3131 | 	case T2P_COMPRESS_JPEG:
3132 | 		if (t2p->tiff_photometric==PHOTOMETRIC_YCBCR) {
3133 | 			uint16 hor = 0, ver = 0;
3134 | 			if (TIFFGetField(input, TIFFTAG_YCBCRSUBSAMPLING, &hor, &ver)!=0) {
3135 | 				if (hor != 0 && ver != 0) {
3136 | 					TIFFSetField(output, TIFFTAG_YCBCRSUBSAMPLING, hor, ver);
3137 | 				}
3138 | 			}
3139 | 			if(TIFFGetField(input, TIFFTAG_REFERENCEBLACKWHITE, &xfloatp)!=0){
3140 | 				TIFFSetField(output, TIFFTAG_REFERENCEBLACKWHITE, xfloatp);
3141 | 			}
3142 | 		}
3143 | 		TIFFSetField(output, TIFFTAG_COMPRESSION, COMPRESSION_JPEG);
3144 | 		TIFFSetField(output, TIFFTAG_JPEGTABLESMODE, 0); /* JPEGTABLESMODE_NONE */
3145 | 		if(t2p->pdf_colorspace & (T2P_CS_RGB | T2P_CS_LAB)){
3146 | 			TIFFSetField(output, TIFFTAG_PHOTOMETRIC, PHOTOMETRIC_YCBCR);
3147 | 			if(t2p->tiff_photometric != PHOTOMETRIC_YCBCR){
3148 | 				TIFFSetField(output, TIFFTAG_JPEGCOLORMODE, JPEGCOLORMODE_RGB);
3149 | 			} else {
3150 | 				TIFFSetField(output, TIFFTAG_JPEGCOLORMODE, JPEGCOLORMODE_RAW);
3151 | 			}
3152 | 		}
3153 | 		if(t2p->pdf_colorspace & T2P_CS_GRAY){
3154 | 			(void)0;
3155 | 		}
3156 | 		if(t2p->pdf_colorspace & T2P_CS_CMYK){
3157 | 			(void)0;
3158 | 		}
3159 | 		if(t2p->pdf_defaultcompressionquality != 0){
3160 | 			TIFFSetField(output, 
3161 | 				TIFFTAG_JPEGQUALITY, 
3162 | 				t2p->pdf_defaultcompressionquality);
3163 | 		}
3164 | 		break;
3165 | #endif
3166 | #ifdef ZIP_SUPPORT
3167 | 	case T2P_COMPRESS_ZIP:
3168 | 		TIFFSetField(output, TIFFTAG_COMPRESSION, COMPRESSION_DEFLATE);
3169 | 		if(t2p->pdf_defaultcompressionquality%100 != 0){
3170 | 			TIFFSetField(output, 
3171 | 				TIFFTAG_PREDICTOR, 
3172 | 				t2p->pdf_defaultcompressionquality % 100);
3173 | 		}
3174 | 		if(t2p->pdf_defaultcompressionquality/100 != 0){
3175 | 			TIFFSetField(output, 
3176 | 				TIFFTAG_ZIPQUALITY, 
3177 | 				(t2p->pdf_defaultcompressionquality / 100));
3178 | 		}
3179 | 		break;
3180 | #endif
3181 | 	default:
3182 | 		break;
3183 | 	}
3184 | 
3185 | 	t2p_enable(output);
3186 | 	t2p->outputwritten = 0;
3187 | 	bufferoffset = TIFFWriteEncodedStrip(output, (tstrip_t) 0, buffer,
3188 | 					     TIFFStripSize(output)); 
3189 | 	if (buffer != NULL) {
3190 | 		_TIFFfree(buffer);
3191 | 		buffer = NULL;
3192 | 	}
3193 | 	if (bufferoffset == -1) {
3194 | 		TIFFError(TIFF2PDF_MODULE, 
3195 | 			  "Error writing encoded tile to output PDF %s", 
3196 | 			  TIFFFileName(output));
3197 | 		t2p->t2p_error = T2P_ERR_ERROR;
3198 | 		return(0);
3199 | 	}
3200 | 	
3201 | 	written = t2p->outputwritten;
3202 | 	
3203 | 	return(written);
3204 | }
