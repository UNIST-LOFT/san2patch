 132 | {
 133 | 	jas_image_t *image;
 134 | 	uint_fast32_t rawsize;
 135 | 	uint_fast32_t inmem;
 136 | 	int cmptno;
 137 | 	jas_image_cmptparm_t *cmptparm;
 138 | 
 139 | 	if (!(image = jas_image_create0())) {
 140 | 		return 0;
 141 | 	}
 142 | 
 143 | 	image->clrspc_ = clrspc;
 144 | 	image->maxcmpts_ = numcmpts;
 145 | 	image->inmem_ = true;
 146 | 
 147 | 	/* Allocate memory for the per-component information. */
 148 | 	if (!(image->cmpts_ = jas_alloc2(image->maxcmpts_,
 149 | 	  sizeof(jas_image_cmpt_t *)))) {
 150 | 		jas_image_destroy(image);
 151 | 		return 0;
 152 | 	}
 153 | 	/* Initialize in case of failure. */
 154 | 	for (cmptno = 0; cmptno < image->maxcmpts_; ++cmptno) {
 155 | 		image->cmpts_[cmptno] = 0;
 156 | 	}
 157 | 
 158 | 	/* Compute the approximate raw size of the image. */
 159 | 	rawsize = 0;
 160 | 	for (cmptno = 0, cmptparm = cmptparms; cmptno < numcmpts; ++cmptno,
 161 | 	  ++cmptparm) {
 162 | 		rawsize += cmptparm->width * cmptparm->height *
 163 | 		  (cmptparm->prec + 7) / 8; // PATCH LOCATION
 164 | 	}
 165 | 	/* Decide whether to buffer the image data in memory, based on the
 166 | 	  raw size of the image. */
 167 | 	inmem = (rawsize < JAS_IMAGE_INMEMTHRESH);
 168 | 
 169 | 	/* Create the individual image components. */
 170 | 	for (cmptno = 0, cmptparm = cmptparms; cmptno < numcmpts; ++cmptno,
 171 | 	  ++cmptparm) {
 172 | 		if (!(image->cmpts_[cmptno] = jas_image_cmpt_create(cmptparm->tlx,
 173 | 		  cmptparm->tly, cmptparm->hstep, cmptparm->vstep,
 174 | 		  cmptparm->width, cmptparm->height, cmptparm->prec,
 175 | 		  cmptparm->sgnd, inmem))) {
 176 | 			jas_image_destroy(image);
 177 | 			return 0;
 178 | 		}
 179 | 		++image->numcmpts_;
 180 | 	}
 181 | 
 182 | 	/* Determine the bounding box for all of the components on the
 183 | 	  reference grid (i.e., the image area) */
 184 | 	jas_image_setbbox(image);
 185 | 
 186 | 	return image;
 187 | }
 188 | 
 189 | jas_image_t *jas_image_create0()
