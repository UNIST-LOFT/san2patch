 301 | LOCAL(boolean)
 302 | get_sos (j_decompress_ptr cinfo)
 303 | /* Process a SOS marker */
 304 | {
 305 |   INT32 length;
 306 |   int i, ci, n, c, cc;
 307 |   jpeg_component_info * compptr;
 308 |   INPUT_VARS(cinfo);
 309 | 
 310 |   if (! cinfo->marker->saw_SOF)
 311 |     ERREXIT(cinfo, JERR_SOS_NO_SOF);
 312 | 
 313 |   INPUT_2BYTES(cinfo, length, return FALSE);
 314 | 
 315 |   INPUT_BYTE(cinfo, n, return FALSE); /* Number of components */
 316 | 
 317 |   TRACEMS1(cinfo, 1, JTRC_SOS, n);
 318 | 
 319 |   if (length != (n * 2 + 6) || n < 1 || n > MAX_COMPS_IN_SCAN)
 320 |     ERREXIT(cinfo, JERR_BAD_LENGTH);
 321 | 
 322 |   cinfo->comps_in_scan = n;
 323 | 
 324 |   /* Collect the component-spec parameters */
 325 |  // PATCH LOCATION
 326 |   for (i = 0; i < cinfo->num_components; i++)
 327 |     cinfo->cur_comp_info[i] = NULL;
 328 | 
 329 |   for (i = 0; i < n; i++) {
 330 |     INPUT_BYTE(cinfo, cc, return FALSE);
 331 |     INPUT_BYTE(cinfo, c, return FALSE);
 332 |     
 333 |     for (ci = 0, compptr = cinfo->comp_info; ci < cinfo->num_components;
 334 | 	 ci++, compptr++) {
 335 |       if (cc == compptr->component_id && !cinfo->cur_comp_info[ci])
 336 | 	goto id_found;
 337 |     }
 338 | 
 339 |     ERREXIT1(cinfo, JERR_BAD_COMPONENT_ID, cc);
 340 | 
 341 |   id_found:
 342 | 
 343 |     cinfo->cur_comp_info[i] = compptr;
 344 |     compptr->dc_tbl_no = (c >> 4) & 15;
 345 |     compptr->ac_tbl_no = (c     ) & 15;
 346 |     
 347 |     TRACEMS3(cinfo, 1, JTRC_SOS_COMPONENT, cc,
 348 | 	     compptr->dc_tbl_no, compptr->ac_tbl_no);
 349 |   }
 350 | 
 351 |   /* Collect the additional scan parameters Ss, Se, Ah/Al. */
 352 |   INPUT_BYTE(cinfo, c, return FALSE);
 353 |   cinfo->Ss = c;
 354 |   INPUT_BYTE(cinfo, c, return FALSE);
 355 |   cinfo->Se = c;
 356 |   INPUT_BYTE(cinfo, c, return FALSE);
 357 |   cinfo->Ah = (c >> 4) & 15;
 358 |   cinfo->Al = (c     ) & 15;
 359 | 
 360 |   TRACEMS4(cinfo, 1, JTRC_SOS_PARAMS, cinfo->Ss, cinfo->Se,
 361 | 	   cinfo->Ah, cinfo->Al);
 362 | 
 363 |   /* Prepare to scan data & restart markers */
 364 |   cinfo->marker->next_restart_num = 0;
 365 | 
 366 |   /* Count another SOS marker */
 367 |   cinfo->input_scan_number++;
 368 | 
 369 |   INPUT_SYNC(cinfo);
 370 |   return TRUE;
 371 | }
