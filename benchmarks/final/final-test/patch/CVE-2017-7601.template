1576 | static int
1577 | JPEGSetupEncode(TIFF* tif)
1578 | {
1579 | 	JPEGState* sp = JState(tif);
1580 | 	TIFFDirectory *td = &tif->tif_dir;
1581 | 	static const char module[] = "JPEGSetupEncode";
1582 | 
1583 | #if defined(JPEG_DUAL_MODE_8_12) && !defined(TIFFInitJPEG)
1584 |         if( tif->tif_dir.td_bitspersample == 12 )
1585 |             return TIFFReInitJPEG_12( tif, COMPRESSION_JPEG, 1 );
1586 | #endif
1587 | 
1588 |         JPEGInitializeLibJPEG( tif, FALSE );
1589 | 
1590 | 	assert(sp != NULL);
1591 | 	assert(!sp->cinfo.comm.is_decompressor);
1592 | 
1593 | 	sp->photometric = td->td_photometric;
1594 | 
1595 | 	/*
1596 | 	 * Initialize all JPEG parameters to default values.
1597 | 	 * Note that jpeg_set_defaults needs legal values for
1598 | 	 * in_color_space and input_components.
1599 | 	 */
1600 | 	if (td->td_planarconfig == PLANARCONFIG_CONTIG) {
1601 | 		sp->cinfo.c.input_components = td->td_samplesperpixel;
1602 | 		if (sp->photometric == PHOTOMETRIC_YCBCR) {
1603 | 			if (sp->jpegcolormode == JPEGCOLORMODE_RGB) {
1604 | 				sp->cinfo.c.in_color_space = JCS_RGB;
1605 | 			} else {
1606 | 				sp->cinfo.c.in_color_space = JCS_YCbCr;
1607 | 			}
1608 | 		} else {
1609 | 			if ((td->td_photometric == PHOTOMETRIC_MINISWHITE || td->td_photometric == PHOTOMETRIC_MINISBLACK) && td->td_samplesperpixel == 1)
1610 | 				sp->cinfo.c.in_color_space = JCS_GRAYSCALE;
1611 | 			else if (td->td_photometric == PHOTOMETRIC_RGB && td->td_samplesperpixel == 3)
1612 | 				sp->cinfo.c.in_color_space = JCS_RGB;
1613 | 			else if (td->td_photometric == PHOTOMETRIC_SEPARATED && td->td_samplesperpixel == 4)
1614 | 				sp->cinfo.c.in_color_space = JCS_CMYK;
1615 | 			else
1616 | 				sp->cinfo.c.in_color_space = JCS_UNKNOWN;
1617 | 		}
1618 | 	} else {
1619 | 		sp->cinfo.c.input_components = 1;
1620 | 		sp->cinfo.c.in_color_space = JCS_UNKNOWN;
1621 | 	}
1622 | 	if (!TIFFjpeg_set_defaults(sp))
1623 | 		return (0);
1624 | 	/* Set per-file parameters */
1625 | 	switch (sp->photometric) {
1626 | 	case PHOTOMETRIC_YCBCR:
1627 | 		sp->h_sampling = td->td_ycbcrsubsampling[0];
1628 | 		sp->v_sampling = td->td_ycbcrsubsampling[1];
1629 |                 if( sp->h_sampling == 0 || sp->v_sampling == 0 )
1630 |                 {
1631 |                     TIFFErrorExt(tif->tif_clientdata, module,
1632 |                             "Invalig horizontal/vertical sampling value");
1633 |                     return (0);
1634 |                 } // PATCH LOCATION
1635 |      if (<PATCH>) return 0;
1636 | 		/*
1637 | 		 * A ReferenceBlackWhite field *must* be present since the
1638 | 		 * default value is inappropriate for YCbCr.  Fill in the
1639 | 		 * proper value if application didn't set it.
1640 | 		 */
1641 | 		{
1642 | 			float *ref;
1643 | 			if (!TIFFGetField(tif, TIFFTAG_REFERENCEBLACKWHITE,
1644 | 					  &ref)) {
1645 | 				float refbw[6];
1646 | 				long top = 1L << td->td_bitspersample;
1647 | 				refbw[0] = 0;
1648 | 				refbw[1] = (float)(top-1L);
1649 | 				refbw[2] = (float)(top>>1);
1650 | 				refbw[3] = refbw[1];
1651 | 				refbw[4] = refbw[2];
1652 | 				refbw[5] = refbw[1];
1653 | 				TIFFSetField(tif, TIFFTAG_REFERENCEBLACKWHITE,
1654 | 					     refbw);
1655 | 			}
1656 | 		}
1657 | 		break;
1658 | 	case PHOTOMETRIC_PALETTE:		/* disallowed by Tech Note */
1659 | 	case PHOTOMETRIC_MASK:
1660 | 		TIFFErrorExt(tif->tif_clientdata, module,
1661 | 			  "PhotometricInterpretation %d not allowed for JPEG",
1662 | 			  (int) sp->photometric);
1663 | 		return (0);
1664 | 	default:
1665 | 		/* TIFF 6.0 forbids subsampling of all other color spaces */
1666 | 		sp->h_sampling = 1;
1667 | 		sp->v_sampling = 1;
1668 | 		break;
1669 | 	}
1670 | 
1671 | 	/* Verify miscellaneous parameters */
1672 | 
1673 | 	/*
1674 | 	 * This would need work if libtiff ever supports different
1675 | 	 * depths for different components, or if libjpeg ever supports
1676 | 	 * run-time selection of depth.  Neither is imminent.
1677 | 	 */
1678 | #ifdef JPEG_LIB_MK1
1679 |         /* BITS_IN_JSAMPLE now permits 8 and 12 --- dgilbert */
1680 | 	if (td->td_bitspersample != 8 && td->td_bitspersample != 12) 
1681 | #else
1682 | 	if (td->td_bitspersample != BITS_IN_JSAMPLE )
1683 | #endif
1684 | 	{
1685 | 		TIFFErrorExt(tif->tif_clientdata, module, "BitsPerSample %d not allowed for JPEG",
1686 | 			  (int) td->td_bitspersample);
1687 | 		return (0);
1688 | 	}
1689 | 	sp->cinfo.c.data_precision = td->td_bitspersample;
1690 | #ifdef JPEG_LIB_MK1
1691 |         sp->cinfo.c.bits_in_jsample = td->td_bitspersample;
1692 | #endif
1693 | 	if (isTiled(tif)) {
1694 | 		if ((td->td_tilelength % (sp->v_sampling * DCTSIZE)) != 0) {
1695 | 			TIFFErrorExt(tif->tif_clientdata, module,
1696 | 				  "JPEG tile height must be multiple of %d",
1697 | 				  sp->v_sampling * DCTSIZE);
1698 | 			return (0);
1699 | 		}
1700 | 		if ((td->td_tilewidth % (sp->h_sampling * DCTSIZE)) != 0) {
1701 | 			TIFFErrorExt(tif->tif_clientdata, module,
1702 | 				  "JPEG tile width must be multiple of %d",
1703 | 				  sp->h_sampling * DCTSIZE);
1704 | 			return (0);
1705 | 		}
1706 | 	} else {
1707 | 		if (td->td_rowsperstrip < td->td_imagelength &&
1708 | 		    (td->td_rowsperstrip % (sp->v_sampling * DCTSIZE)) != 0) {
1709 | 			TIFFErrorExt(tif->tif_clientdata, module,
1710 | 				  "RowsPerStrip must be multiple of %d for JPEG",
1711 | 				  sp->v_sampling * DCTSIZE);
1712 | 			return (0);
1713 | 		}
1714 | 	}
1715 | 
1716 | 	/* Create a JPEGTables field if appropriate */
1717 | 	if (sp->jpegtablesmode & (JPEGTABLESMODE_QUANT|JPEGTABLESMODE_HUFF)) {
1718 |                 if( sp->jpegtables == NULL
1719 |                     || memcmp(sp->jpegtables,"\0\0\0\0\0\0\0\0\0",8) == 0 )
1720 |                 {
1721 |                         if (!prepare_JPEGTables(tif))
1722 |                                 return (0);
1723 |                         /* Mark the field present */
1724 |                         /* Can't use TIFFSetField since BEENWRITING is already set! */
1725 |                         tif->tif_flags |= TIFF_DIRTYDIRECT;
1726 |                         TIFFSetFieldBit(tif, FIELD_JPEGTABLES);
1727 |                 }
1728 | 	} else {
1729 | 		/* We do not support application-supplied JPEGTables, */
1730 | 		/* so mark the field not present */
1731 | 		TIFFClrFieldBit(tif, FIELD_JPEGTABLES);
1732 | 	}
1733 | 
1734 | 	/* Direct libjpeg output to libtiff's output buffer */
1735 | 	TIFFjpeg_data_dest(sp, tif);
1736 | 
1737 | 	return (1);
1738 | }
