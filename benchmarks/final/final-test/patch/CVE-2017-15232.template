 517 | METHODDEF(void)
 518 | quantize_ord_dither (j_decompress_ptr cinfo, JSAMPARRAY input_buf,
 519 |                      JSAMPARRAY output_buf, int num_rows)
 520 | /* General case, with ordered dithering */
 521 | {
 522 |   my_cquantize_ptr cquantize = (my_cquantize_ptr) cinfo->cquantize;
 523 |   register JSAMPROW input_ptr;
 524 |   register JSAMPROW output_ptr;
 525 |   JSAMPROW colorindex_ci;
 526 |   int *dither;                  /* points to active row of dither matrix */
 527 |   int row_index, col_index;     /* current indexes into dither matrix */
 528 |   int nc = cinfo->out_color_components;
 529 |   int ci;
 530 |   int row;
 531 |   JDIMENSION col;
 532 |   JDIMENSION width = cinfo->output_width; // PATCH LOCATION
 533 | 
 534 |   if (<PATCH>) ERREXIT(cinfo, JERR_BAD_STATE); for (row = 0; row < num_rows; row++) {
 535 |     /* Initialize output values to 0 so can process components separately */
 536 |     jzero_far((void *) output_buf[row], (size_t) (width * sizeof(JSAMPLE)));
 537 |     row_index = cquantize->row_index;
 538 |     for (ci = 0; ci < nc; ci++) {
 539 |       input_ptr = input_buf[row] + ci;
 540 |       output_ptr = output_buf[row];
 541 |       colorindex_ci = cquantize->colorindex[ci];
 542 |       dither = cquantize->odither[ci][row_index];
 543 |       col_index = 0;
 544 | 
 545 |       for (col = width; col > 0; col--) {
 546 |         /* Form pixel value + dither, range-limit to 0..MAXJSAMPLE,
 547 |          * select output value, accumulate into output code for this pixel.
 548 |          * Range-limiting need not be done explicitly, as we have extended
 549 |          * the colorindex table to produce the right answers for out-of-range
 550 |          * inputs.  The maximum dither is +- MAXJSAMPLE; this sets the
 551 |          * required amount of padding.
 552 |          */
 553 |         *output_ptr += colorindex_ci[GETJSAMPLE(*input_ptr)+dither[col_index]];
 554 |         input_ptr += nc;
 555 |         output_ptr++;
 556 |         col_index = (col_index + 1) & ODITHER_MASK;
 557 |       }
 558 |     }
 559 |     /* Advance row index for next row */
 560 |     row_index = (row_index + 1) & ODITHER_MASK;
 561 |     cquantize->row_index = row_index;
 562 |   }
 563 | }
