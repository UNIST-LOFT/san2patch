1070 | 
1071 | 	inbuf = _TIFFmalloc(scanlinesizein);
1072 | 	outbuf = _TIFFmalloc(scanlinesizeout);
1073 | 	if (!inbuf || !outbuf)
1074 | 		goto bad;
1075 | 	_TIFFmemset(inbuf, 0, scanlinesizein);
1076 | 	_TIFFmemset(outbuf, 0, scanlinesizeout);
1077 | 	/* unpack channels */
1078 | 	for (s = 0; s < spp; s++) {
1079 | 		for (row = 0; row < imagelength; row++) {
1080 | 			if (TIFFReadScanline(in, inbuf, row, 0) < 0
1081 | 			    && !ignore) {
1082 | 				TIFFError(TIFFFileName(in),
1083 | 				    "Error, can't read scanline %lu",
1084 | 				    (unsigned long) row);
1085 | 				goto bad;
1086 | 			}
1087 | 			inp = ((uint8*)inbuf) + s;
1088 | 			outp = (uint8*)outbuf;
1089 | 			for (n = imagewidth; n-- > 0;) {
1090 | 				*outp++ = *inp;
1091 | 				inp += spp;
1092 | 			}
1093 | 			if (TIFFWriteScanline(out, outbuf, row, s) < 0) {
1094 | 				TIFFError(TIFFFileName(out),
1095 | 				    "Error, can't write scanline %lu",
1096 | 				    (unsigned long) row);
1097 | 				goto bad;
1098 | 			}
1099 | 		}
1100 | 	}
1101 | 	if (inbuf) _TIFFfree(inbuf);
1102 | 	if (outbuf) _TIFFfree(outbuf);
1103 | 	return 1;
1104 | bad:
1105 | 	if (inbuf) _TIFFfree(inbuf);
1106 | 	if (outbuf) _TIFFfree(outbuf);
1107 | 	return 0;
1108 | }
