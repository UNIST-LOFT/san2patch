1575 | 
1576 | static int
1577 | JPEGSetupEncode(TIFF* tif)
1578 | {
1579 | 	JPEGState* sp = JState(tif);
1580 | 	TIFFDirectory *td = &tif->tif_dir;
1581 | 	static const char module[] = "JPEGSetupEncode";
1582 | 
1583 | #if defined(JPEG_DUAL_MODE_8_12) && !defined(TIFFInitJPEG)
1584 |         if( tif->tif_dir.td_bitspersample == 12 )
1585 |             return TIFFReInitJPEG_12( tif, COMPRESSION_JPEG, 1 );
1586 | #endif
1587 | 
1588 |         JPEGInitializeLibJPEG( tif, FALSE );
1589 | 
1590 | 	assert(sp != NULL);
1591 | 	assert(!sp->cinfo.comm.is_decompressor);
1592 | 
1593 | 	sp->photometric = td->td_photometric;
1594 | 
1595 | 	/*
1596 | 	 * Initialize all JPEG parameters to default values.
1597 | 	 * Note that jpeg_set_defaults needs legal values for
1598 | 	 * in_color_space and input_components.
1599 | 	 */
1600 | 	if (td->td_planarconfig == PLANARCONFIG_CONTIG) {
1601 | 		sp->cinfo.c.input_components = td->td_samplesperpixel;
1602 | 		if (sp->photometric == PHOTOMETRIC_YCBCR) {
1603 | 			if (sp->jpegcolormode == JPEGCOLORMODE_RGB) {
1604 | 				sp->cinfo.c.in_color_space = JCS_RGB;
1605 | 			} else {
1606 | 				sp->cinfo.c.in_color_space = JCS_YCbCr;
1607 | 			}
1608 | 		} else {
1609 | 			if ((td->td_photometric == PHOTOMETRIC_MINISWHITE || td->td_photometric == PHOTOMETRIC_MINISBLACK) && td->td_samplesperpixel == 1)
1610 | 				sp->cinfo.c.in_color_space = JCS_GRAYSCALE;
1611 | 			else if (td->td_photometric == PHOTOMETRIC_RGB && td->td_samplesperpixel == 3)
1612 | 				sp->cinfo.c.in_color_space = JCS_RGB;
1613 | 			else if (td->td_photometric == PHOTOMETRIC_SEPARATED && td->td_samplesperpixel == 4)
1614 | 				sp->cinfo.c.in_color_space = JCS_CMYK;
1615 | 			else
1616 | 				sp->cinfo.c.in_color_space = JCS_UNKNOWN;
1617 | 		}
1618 | 	} else {
1619 | 		sp->cinfo.c.input_components = 1;
1620 | 		sp->cinfo.c.in_color_space = JCS_UNKNOWN;
1621 | 	}
1622 | 	if (!TIFFjpeg_set_defaults(sp))
1623 | 		return (0);
1624 | 	/* Set per-file parameters */
1625 | 	switch (sp->photometric) {
1626 | 	case PHOTOMETRIC_YCBCR:
1627 | 		sp->h_sampling = td->td_ycbcrsubsampling[0];
1628 | 		sp->v_sampling = td->td_ycbcrsubsampling[1];
1629 | 		/*
1630 | 		 * A ReferenceBlackWhite field *must* be present since the
1631 | 		 * default value is inappropriate for YCbCr.  Fill in the
1632 | 		 * proper value if application didn't set it.
1633 | 		 */
1634 | 		{
1635 | 			float *ref;
1636 | 			if (!TIFFGetField(tif, TIFFTAG_REFERENCEBLACKWHITE,
1637 | 					  &ref)) {
1638 | 				float refbw[6];
1639 | 				long top = 1L << td->td_bitspersample;
1640 | 				refbw[0] = 0;
1641 | 				refbw[1] = (float)(top-1L);
1642 | 				refbw[2] = (float)(top>>1);
1643 | 				refbw[3] = refbw[1];
1644 | 				refbw[4] = refbw[2];
1645 | 				refbw[5] = refbw[1];
1646 | 				TIFFSetField(tif, TIFFTAG_REFERENCEBLACKWHITE,
1647 | 					     refbw);
1648 | 			}
1649 | 		}
1650 | 		break;
1651 | 	case PHOTOMETRIC_PALETTE:		/* disallowed by Tech Note */
1652 | 	case PHOTOMETRIC_MASK:
1653 | 		TIFFErrorExt(tif->tif_clientdata, module,
1654 | 			  "PhotometricInterpretation %d not allowed for JPEG",
1655 | 			  (int) sp->photometric);
1656 | 		return (0);
1657 | 	default:
1658 | 		/* TIFF 6.0 forbids subsampling of all other color spaces */
1659 | 		sp->h_sampling = 1;
1660 | 		sp->v_sampling = 1;
1661 | 		break;
1662 | 	}
1663 | 
1664 | 	/* Verify miscellaneous parameters */
1665 | 
1666 | 	/*
1667 | 	 * This would need work if libtiff ever supports different
1668 | 	 * depths for different components, or if libjpeg ever supports
1669 | 	 * run-time selection of depth.  Neither is imminent.
1670 | 	 */
1671 | #ifdef JPEG_LIB_MK1
1672 |         /* BITS_IN_JSAMPLE now permits 8 and 12 --- dgilbert */
1673 | 	if (td->td_bitspersample != 8 && td->td_bitspersample != 12) 
1674 | #else
1675 | 	if (td->td_bitspersample != BITS_IN_JSAMPLE )
1676 | #endif
1677 | 	{
1678 | 		TIFFErrorExt(tif->tif_clientdata, module, "BitsPerSample %d not allowed for JPEG",
1679 | 			  (int) td->td_bitspersample);
1680 | 		return (0);
1681 | 	}
1682 | 	sp->cinfo.c.data_precision = td->td_bitspersample;
1683 | #ifdef JPEG_LIB_MK1
1684 |         sp->cinfo.c.bits_in_jsample = td->td_bitspersample;
1685 | #endif // PATCH LOCATION
1686 | 	if (isTiled(tif)) {
1687 | 		if ((td->td_tilelength % (sp->v_sampling * DCTSIZE)) != 0) {
1688 | 			TIFFErrorExt(tif->tif_clientdata, module,
1689 | 				  "JPEG tile height must be multiple of %d",
1690 | 				  sp->v_sampling * DCTSIZE);
1691 | 			return (0);
1692 | 		}
1693 | 		if ((td->td_tilewidth % (sp->h_sampling * DCTSIZE)) != 0) {
1694 | 			TIFFErrorExt(tif->tif_clientdata, module,
1695 | 				  "JPEG tile width must be multiple of %d",
1696 | 				  sp->h_sampling * DCTSIZE);
1697 | 			return (0);
1698 | 		}
1699 | 	} else {
1700 | 		if (td->td_rowsperstrip < td->td_imagelength &&
1701 | 		    (td->td_rowsperstrip % (sp->v_sampling * DCTSIZE)) != 0) {
1702 | 			TIFFErrorExt(tif->tif_clientdata, module,
1703 | 				  "RowsPerStrip must be multiple of %d for JPEG",
1704 | 				  sp->v_sampling * DCTSIZE);
1705 | 			return (0);
1706 | 		}
1707 | 	}
1708 | 
1709 | 	/* Create a JPEGTables field if appropriate */
1710 | 	if (sp->jpegtablesmode & (JPEGTABLESMODE_QUANT|JPEGTABLESMODE_HUFF)) {
1711 |                 if( sp->jpegtables == NULL
1712 |                     || memcmp(sp->jpegtables,"\0\0\0\0\0\0\0\0\0",8) == 0 )
1713 |                 {
1714 |                         if (!prepare_JPEGTables(tif))
1715 |                                 return (0);
1716 |                         /* Mark the field present */
1717 |                         /* Can't use TIFFSetField since BEENWRITING is already set! */
1718 |                         tif->tif_flags |= TIFF_DIRTYDIRECT;
1719 |                         TIFFSetFieldBit(tif, FIELD_JPEGTABLES);
1720 |                 }
1721 | 	} else {
1722 | 		/* We do not support application-supplied JPEGTables, */
1723 | 		/* so mark the field not present */
1724 | 		TIFFClrFieldBit(tif, FIELD_JPEGTABLES);
1725 | 	}
1726 | 
1727 | 	/* Direct libjpeg output to libtiff's output buffer */
1728 | 	TIFFjpeg_data_dest(sp, tif);
1729 | 
1730 | 	return (1);
1731 | }
