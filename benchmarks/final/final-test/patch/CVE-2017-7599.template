 942 | static int
 943 | TIFFWriteDirectoryTagSampleformatArray(TIFF* tif, uint32* ndir, TIFFDirEntry* dir, uint16 tag, uint32 count, double* value)
 944 | {
 945 | 	static const char module[] = "TIFFWriteDirectoryTagSampleformatArray";
 946 | 	void* conv;
 947 | 	uint32 i;
 948 | 	int ok;
 949 | 	conv = _TIFFmalloc(count*sizeof(double));
 950 | 	if (conv == NULL)
 951 | 	{
 952 | 		TIFFErrorExt(tif->tif_clientdata, module, "Out of memory");
 953 | 		return (0);
 954 | 	}
 955 | 
 956 | 	switch (tif->tif_dir.td_sampleformat)
 957 | 	{
 958 | 		case SAMPLEFORMAT_IEEEFP:
 959 | 			if (tif->tif_dir.td_bitspersample<=32)
 960 | 			{
 961 | 				for (i = 0; i < count; ++i)
 962 | 					((float*)conv)[i] = (float)value[i];
 963 | 				ok = TIFFWriteDirectoryTagFloatArray(tif,ndir,dir,tag,count,(float*)conv);
 964 | 			}
 965 | 			else
 966 | 			{
 967 | 				ok = TIFFWriteDirectoryTagDoubleArray(tif,ndir,dir,tag,count,value);
 968 | 			}
 969 | 			break;
 970 | 		case SAMPLEFORMAT_INT:
 971 | 			if (tif->tif_dir.td_bitspersample<=8)
 972 | 			{
 973 | 				for (i = 0; i < count; ++i)
 974 | 					((int8*)conv)[i] = (int8)value[i];
 975 | 				ok = TIFFWriteDirectoryTagSbyteArray(tif,ndir,dir,tag,count,(int8*)conv);
 976 | 			}
 977 | 			else if (tif->tif_dir.td_bitspersample<=16)
 978 | 			{
 979 | 				for (i = 0; i < count; ++i) // PATCH LOCATION
 980 | 					((int16*)conv)[i] = (int16)value[i];
 981 | 				ok = TIFFWriteDirectoryTagSshortArray(tif,ndir,dir,tag,count,(int16*)conv);
 982 | 			}
 983 | 			else
 984 | 			{
 985 | 				for (i = 0; i < count; ++i)
 986 | 					((int32*)conv)[i] = (int32)value[i];
 987 | 				ok = TIFFWriteDirectoryTagSlongArray(tif,ndir,dir,tag,count,(int32*)conv);
 988 | 			}
 989 | 			break;
 990 | 		case SAMPLEFORMAT_UINT:
 991 | 			if (tif->tif_dir.td_bitspersample<=8)
 992 | 			{
 993 | 				for (i = 0; i < count; ++i)
 994 | 					((uint8*)conv)[i] = (uint8)value[i];
 995 | 				ok = TIFFWriteDirectoryTagByteArray(tif,ndir,dir,tag,count,(uint8*)conv);
 996 | 			}
 997 | 			else if (tif->tif_dir.td_bitspersample<=16)
 998 | 			{
 999 | 				for (i = 0; i < count; ++i)
1000 | 					((uint16*)conv)[i] = (uint16)value[i];
1001 | 				ok = TIFFWriteDirectoryTagShortArray(tif,ndir,dir,tag,count,(uint16*)conv);
1002 | 			}
1003 | 			else
1004 | 			{
1005 | 				for (i = 0; i < count; ++i)
1006 | 					((uint32*)conv)[i] = (uint32)value[i];
1007 | 				ok = TIFFWriteDirectoryTagLongArray(tif,ndir,dir,tag,count,(uint32*)conv);
1008 | 			}
1009 | 			break;
1010 | 		default:
1011 | 			ok = 0;
1012 | 	}
1013 | 
1014 | 	_TIFFfree(conv);
1015 | 	return (ok);
1016 | }
