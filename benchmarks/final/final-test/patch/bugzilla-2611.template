 801 | 
 802 | static int
 803 | OJPEGDecodeRaw(TIFF* tif, uint8* buf, tmsize_t cc)
 804 | {
 805 | 	static const char module[]="OJPEGDecodeRaw";
 806 | 	OJPEGState* sp=(OJPEGState*)tif->tif_data;
 807 | 	uint8* m;
 808 | 	tmsize_t n;
 809 | 	uint8* oy;
 810 | 	uint8* ocb;
 811 | 	uint8* ocr;
 812 | 	uint8* p;
 813 | 	uint32 q;
 814 | 	uint8* r; // PATCH LOCATION 815 | 	uint8 sx,sy;
 816 | 	if (cc%sp->bytes_per_line!=0)
 817 | 	{
 818 | 		TIFFErrorExt(tif->tif_clientdata,module,"Fractional scanline not read");
 819 | 		return(0);
 820 | 	}
 821 | 	assert(cc>0);
 822 | 	m=buf;
 823 | 	n=cc;
 824 | 	do
 825 | 	{
 826 | 		if (sp->subsampling_convert_state==0)
 827 | 		{
 828 | 			if (jpeg_read_raw_data_encap(sp,&(sp->libjpeg_jpeg_decompress_struct),sp->subsampling_convert_ycbcrimage,sp->subsampling_ver*8)==0)
 829 | 				return(0);
 830 | 		}
 831 | 		oy=sp->subsampling_convert_ybuf+sp->subsampling_convert_state*sp->subsampling_ver*sp->subsampling_convert_ylinelen;
 832 | 		ocb=sp->subsampling_convert_cbbuf+sp->subsampling_convert_state*sp->subsampling_convert_clinelen;
 833 | 		ocr=sp->subsampling_convert_crbuf+sp->subsampling_convert_state*sp->subsampling_convert_clinelen;
 834 | 		p=m;
 835 | 		for (q=0; q<sp->subsampling_convert_clinelenout; q++)
 836 | 		{
 837 | 			r=oy;
 838 | 			for (sy=0; sy<sp->subsampling_ver; sy++)
 839 | 			{
 840 | 				for (sx=0; sx<sp->subsampling_hor; sx++)
 841 | 					*p++=*r++;
 842 | 				r+=sp->subsampling_convert_ylinelen-sp->subsampling_hor;
 843 | 			}
 844 | 			oy+=sp->subsampling_hor;
 845 | 			*p++=*ocb++;
 846 | 			*p++=*ocr++;
 847 | 		}
 848 | 		sp->subsampling_convert_state++;
 849 | 		if (sp->subsampling_convert_state==sp->subsampling_convert_clines)
 850 | 			sp->subsampling_convert_state=0;
 851 | 		m+=sp->bytes_per_line;
 852 | 		n-=sp->bytes_per_line;
 853 | 	} while(n>0);
 854 | 	return(1);
 855 | }
