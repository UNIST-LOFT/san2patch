diff --git a/libtiff/tif_jpeg.c b/libtiff/tif_jpeg.c
index 6c17c388..95dfdec1 100644
--- a/libtiff/tif_jpeg.c
+++ b/libtiff/tif_jpeg.c
@@ -1631,8 +1631,8 @@ JPEGSetupEncode(TIFF* tif)
                     TIFFErrorExt(tif->tif_clientdata, module,
                             "Invalig horizontal/vertical sampling value");
                     return (0);
-                }
-
+                } 
+     if (td->td_bitspersample <= 0 || td->td_bitspersample >= (int)(sizeof(long) * CHAR_BIT) /* guard: prevent undefined left-shift */) return 0;
 		/*
 		 * A ReferenceBlackWhite field *must* be present since the
 		 * default value is inappropriate for YCbCr.  Fill in the
@@ -1641,7 +1641,7 @@ JPEGSetupEncode(TIFF* tif)
 		{
 			float *ref;
 			if (!TIFFGetField(tif, TIFFTAG_REFERENCEBLACKWHITE,
-					  &ref)) {
+				  &ref)) {
 				float refbw[6];
 				long top = 1L << td->td_bitspersample;
 				refbw[0] = 0;
@@ -1651,7 +1651,7 @@ JPEGSetupEncode(TIFF* tif)
 				refbw[4] = refbw[2];
 				refbw[5] = refbw[1];
 				TIFFSetField(tif, TIFFTAG_REFERENCEBLACKWHITE,
-					     refbw);
+					 refbw);
 			}
 		}
 		break;
@@ -1693,22 +1693,22 @@ JPEGSetupEncode(TIFF* tif)
 	if (isTiled(tif)) {
 		if ((td->td_tilelength % (sp->v_sampling * DCTSIZE)) != 0) {
 			TIFFErrorExt(tif->tif_clientdata, module,
-				  "JPEG tile height must be multiple of %d",
-				  sp->v_sampling * DCTSIZE);
+			  "JPEG tile height must be multiple of %d",
+			  sp->v_sampling * DCTSIZE);
 			return (0);
 		}
 		if ((td->td_tilewidth % (sp->h_sampling * DCTSIZE)) != 0) {
 			TIFFErrorExt(tif->tif_clientdata, module,
-				  "JPEG tile width must be multiple of %d",
-				  sp->h_sampling * DCTSIZE);
+			  "JPEG tile width must be multiple of %d",
+			  sp->h_sampling * DCTSIZE);
 			return (0);
 		}
 	} else {
 		if (td->td_rowsperstrip < td->td_imagelength &&
 		    (td->td_rowsperstrip % (sp->v_sampling * DCTSIZE)) != 0) {
 			TIFFErrorExt(tif->tif_clientdata, module,
-				  "RowsPerStrip must be multiple of %d for JPEG",
-				  sp->v_sampling * DCTSIZE);
+			  "RowsPerStrip must be multiple of %d for JPEG",
+			  sp->v_sampling * DCTSIZE);
 			return (0);
 		}
 	}
