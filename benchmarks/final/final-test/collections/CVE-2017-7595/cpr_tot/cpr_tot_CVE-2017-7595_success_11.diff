diff --git a/libtiff/tif_jpeg.c b/libtiff/tif_jpeg.c
index 38595f98..c3faba17 100644
--- a/libtiff/tif_jpeg.c
+++ b/libtiff/tif_jpeg.c
@@ -1572,7 +1572,6 @@ prepare_JPEGTables(TIFF* tif)
 
 	return (1);
 }
-
 static int
 JPEGSetupEncode(TIFF* tif)
 {
@@ -1644,7 +1643,7 @@ JPEGSetupEncode(TIFF* tif)
 				refbw[4] = refbw[2];
 				refbw[5] = refbw[1];
 				TIFFSetField(tif, TIFFTAG_REFERENCEBLACKWHITE,
-					     refbw);
+					 refbw);
 			}
 		}
 		break;
@@ -1682,26 +1681,26 @@ JPEGSetupEncode(TIFF* tif)
 	sp->cinfo.c.data_precision = td->td_bitspersample;
 #ifdef JPEG_LIB_MK1
         sp->cinfo.c.bits_in_jsample = td->td_bitspersample;
-#endif
-	if (isTiled(tif)) {
+#endif 
+	if (isTiled(tif)) { if (sp->h_sampling <= 0 || sp->v_sampling <= 0 || td->td_samplesperpixel == 0) return 0;
 		if ((td->td_tilelength % (sp->v_sampling * DCTSIZE)) != 0) {
 			TIFFErrorExt(tif->tif_clientdata, module,
-				  "JPEG tile height must be multiple of %d",
-				  sp->v_sampling * DCTSIZE);
+			  "JPEG tile height must be multiple of %d",
+			  sp->v_sampling * DCTSIZE);
 			return (0);
 		}
 		if ((td->td_tilewidth % (sp->h_sampling * DCTSIZE)) != 0) {
 			TIFFErrorExt(tif->tif_clientdata, module,
-				  "JPEG tile width must be multiple of %d",
-				  sp->h_sampling * DCTSIZE);
+			  "JPEG tile width must be multiple of %d",
+			  sp->h_sampling * DCTSIZE);
 			return (0);
 		}
 	} else {
 		if (td->td_rowsperstrip < td->td_imagelength &&
 		    (td->td_rowsperstrip % (sp->v_sampling * DCTSIZE)) != 0) {
 			TIFFErrorExt(tif->tif_clientdata, module,
-				  "RowsPerStrip must be multiple of %d for JPEG",
-				  sp->v_sampling * DCTSIZE);
+			  "RowsPerStrip must be multiple of %d for JPEG",
+			  sp->v_sampling * DCTSIZE);
 			return (0);
 		}
 	}
