diff --git a/jdmarker.c b/jdmarker.c
index d8dcba98..3aa280cd 100644
--- a/jdmarker.c
+++ b/jdmarker.c
@@ -319,11 +319,24 @@ get_sos (j_decompress_ptr cinfo)
   if (length != (n * 2 + 6) || n < 1 || n > MAX_COMPS_IN_SCAN)
     ERREXIT(cinfo, JERR_BAD_LENGTH);
 
+  /* Rationale: ensure the scan-declared component count does not exceed
+   * the number of components in the image. Writing beyond the receiver's
+   * cur_comp_info array causes an out-of-bounds write. Fail fast on
+   * malformed marker declarations.
+   */
+  if (n > cinfo->num_components)
+    ERREXIT(cinfo, JERR_BAD_LENGTH);
+
   cinfo->comps_in_scan = n;
 
-  /* Collect the component-spec parameters */
+// FIXME: Crash CWE-787: Out-of-bounds Write
+   /* Collect the component-spec parameters */
 
-  for (i = 0; i < cinfo->num_components; i++)
+  /* Bound the initialization to the actual storage capacity to avoid
+   * writing past the end of cur_comp_info when num_components is
+   * unexpectedly large.
+   */
+  for (i = 0; i < cinfo->num_components && i < MAX_COMPS_IN_SCAN; i++)
     cinfo->cur_comp_info[i] = NULL;
 
   for (i = 0; i < n; i++) {
@@ -345,7 +358,7 @@ get_sos (j_decompress_ptr cinfo)
     compptr->ac_tbl_no = (c     ) & 15;
     
     TRACEMS3(cinfo, 1, JTRC_SOS_COMPONENT, cc,
-	     compptr->dc_tbl_no, compptr->ac_tbl_no);
+	 compptr->dc_tbl_no, compptr->ac_tbl_no);
   }
 
   /* Collect the additional scan parameters Ss, Se, Ah/Al. */
@@ -371,6 +384,7 @@ get_sos (j_decompress_ptr cinfo)
 }
 
 
+
 #ifdef D_ARITH_CODING_SUPPORTED
 
 LOCAL(boolean)
