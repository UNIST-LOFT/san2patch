diff --git a/jdmarker.c b/jdmarker.c
index d8dcba98..12d20428 100644
--- a/jdmarker.c
+++ b/jdmarker.c
@@ -321,31 +321,46 @@ get_sos (j_decompress_ptr cinfo)
 
   cinfo->comps_in_scan = n;
 
-  /* Collect the component-spec parameters */
+  /* Rationale: compute a safe upper bound for component slot operations
+   * based on the frame's num_components and the library's MAX_COMPS_IN_SCAN.
+   * Use this bound for clearing/storing into cinfo->cur_comp_info and
+   * reject markers that claim more components than available slots.
+   */
+  {
+    int max_slots = cinfo->num_components;
+    if (max_slots > MAX_COMPS_IN_SCAN)
+      max_slots = MAX_COMPS_IN_SCAN;
 
-  for (i = 0; i < cinfo->num_components; i++)
-    cinfo->cur_comp_info[i] = NULL;
+    if (n > max_slots)
+      ERREXIT(cinfo, JERR_BAD_LENGTH);
 
-  for (i = 0; i < n; i++) {
-    INPUT_BYTE(cinfo, cc, return FALSE);
-    INPUT_BYTE(cinfo, c, return FALSE);
-    
-    for (ci = 0, compptr = cinfo->comp_info; ci < cinfo->num_components;
-	 ci++, compptr++) {
-      if (cc == compptr->component_id && !cinfo->cur_comp_info[ci])
-	goto id_found;
-    }
+// FIXME: Crash CWE-787: Out-of-bounds Write
+     /* Collect the component-spec parameters */
 
-    ERREXIT1(cinfo, JERR_BAD_COMPONENT_ID, cc);
+    for (i = 0; i < max_slots; i++)
+      cinfo->cur_comp_info[i] = NULL;
 
-  id_found:
+    for (i = 0; i < n; i++) {
+      INPUT_BYTE(cinfo, cc, return FALSE);
+      INPUT_BYTE(cinfo, c, return FALSE);
+      
+      for (ci = 0, compptr = cinfo->comp_info; ci < cinfo->num_components;
+	   ci++, compptr++) {
+        if (cc == compptr->component_id && !cinfo->cur_comp_info[ci])
+	  goto id_found;
+      }
 
-    cinfo->cur_comp_info[i] = compptr;
-    compptr->dc_tbl_no = (c >> 4) & 15;
-    compptr->ac_tbl_no = (c     ) & 15;
-    
-    TRACEMS3(cinfo, 1, JTRC_SOS_COMPONENT, cc,
-	     compptr->dc_tbl_no, compptr->ac_tbl_no);
+      ERREXIT1(cinfo, JERR_BAD_COMPONENT_ID, cc);
+
+    id_found:
+
+      cinfo->cur_comp_info[i] = compptr;
+      compptr->dc_tbl_no = (c >> 4) & 15;
+      compptr->ac_tbl_no = (c     ) & 15;
+      
+      TRACEMS3(cinfo, 1, JTRC_SOS_COMPONENT, cc,
+	       compptr->dc_tbl_no, compptr->ac_tbl_no);
+    }
   }
 
   /* Collect the additional scan parameters Ss, Se, Ah/Al. */
@@ -371,6 +386,7 @@ get_sos (j_decompress_ptr cinfo)
 }
 
 
+
 #ifdef D_ARITH_CODING_SUPPORTED
 
 LOCAL(boolean)
