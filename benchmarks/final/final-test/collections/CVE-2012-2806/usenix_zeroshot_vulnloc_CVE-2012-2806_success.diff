diff --git a/jdmarker.c b/jdmarker.c
index d8dcba98..f5a0e322 100644
--- a/jdmarker.c
+++ b/jdmarker.c
@@ -322,8 +322,16 @@ get_sos (j_decompress_ptr cinfo)
   cinfo->comps_in_scan = n;
 
   /* Collect the component-spec parameters */
-
-  for (i = 0; i < cinfo->num_components; i++)
+// Rationale: Ensure we clear the whole cur_comp_info array (which is sized
+// to MAX_COMPS_IN_SCAN) rather than only the first num_components entries.
+// The original code initialized only cinfo->num_components entries and
+// later wrote up to 'n' entries (the number of components in the scan).
+// If 'n' > cinfo->num_components this could write beyond the initialized
+// range and lead to a stack-buffer-overflow. Clearing all MAX_COMPS_IN_SCAN
+// entries prevents out-of-bounds writes when valid scans use component
+// counts up to MAX_COMPS_IN_SCAN.
+
+  for (i = 0; i < MAX_COMPS_IN_SCAN; i++)
     cinfo->cur_comp_info[i] = NULL;
 
   for (i = 0; i < n; i++) {
@@ -340,6 +348,10 @@ get_sos (j_decompress_ptr cinfo)
 
   id_found:
 
+    /* Bounds check: ensure we do not write past the cur_comp_info array. */
+    if (i >= MAX_COMPS_IN_SCAN)
+      ERREXIT(cinfo, JERR_BAD_LENGTH);
+
     cinfo->cur_comp_info[i] = compptr;
     compptr->dc_tbl_no = (c >> 4) & 15;
     compptr->ac_tbl_no = (c     ) & 15;
